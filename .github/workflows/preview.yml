name: Preview Deployment

on:
  pull_request:
    branches: [main, master]
  push:
    branches-ignore: [main, master]

jobs:
  preview-build:
    runs-on: ubuntu-latest
    name: Preview Build and Test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Build for preview
        run: npm run build
        env:
          # Preview í™˜ê²½ìš© í™˜ê²½ë³€ìˆ˜ (í•„ìš”ì‹œ)
          NODE_ENV: development
          NEXT_PUBLIC_APP_URL: https://preview-ysk-landingpage.vercel.app

      - name: Generate build report
        run: |
          echo "ğŸ“Š ë¹Œë“œ ë¦¬í¬íŠ¸ ìƒì„±"
          echo "ğŸ“… ë¹Œë“œ ì‹œê°„: $(date)"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.head_ref || github.ref_name }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ ì‘ì„±ì: ${{ github.actor }}"

          # ë¹Œë“œ í¬ê¸° ì²´í¬
          if [ -d ".next" ]; then
            echo "ğŸ“¦ ë¹Œë“œ í¬ê¸°:"
            du -sh .next/
          fi

  preview-security-check:
    runs-on: ubuntu-latest
    name: Preview Security Check
    needs: preview-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --production
        continue-on-error: true

      - name: Check package vulnerabilities
        run: |
          echo "ğŸ” íŒ¨í‚¤ì§€ ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
          npm audit --audit-level moderate
        continue-on-error: true

  preview-lighthouse:
    runs-on: ubuntu-latest
    name: Lighthouse Performance Check
    needs: preview-build
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Lighthouse
        run: npm run build

      - name: Start server for testing
        run: |
          npm run start &
          sleep 10
        env:
          PORT: 3000

      - name: Lighthouse Performance Test
        run: |
          echo "ğŸš¨ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸"
          echo "âš¡ ëª©í‘œ: Performance > 90, SEO > 95"
          echo "ğŸ“± ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†± ëª¨ë‘ í…ŒìŠ¤íŠ¸ ì˜ˆì •"
          echo "ğŸ”— ì‹¤ì œ í…ŒìŠ¤íŠ¸ëŠ” Vercel í”„ë¦¬ë·° URLì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤"

  comment-pr:
    runs-on: ubuntu-latest
    name: Comment on PR
    needs: [preview-build, preview-security-check]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const comment = `
            ## ğŸš€ í”„ë¦¬ë·° ë°°í¬ ìƒíƒœ

            **âœ… ë¹Œë“œ ì„±ê³µ!** YSK ëœë”©í˜ì´ì§€ í”„ë¦¬ë·°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.

            ### ğŸ“Š ë°°í¬ ì •ë³´
            - **ğŸŒ¿ ë¸Œëœì¹˜**: \`${context.payload.pull_request.head.ref}\`
            - **ğŸ”— ì»¤ë°‹**: \`${context.sha.slice(0, 7)}\`
            - **ğŸ‘¤ ì‘ì„±ì**: @${context.payload.pull_request.user.login}
            - **ğŸ“… ì‹œê°„**: ${new Date().toLocaleString('ko-KR')}

            ### ğŸ” ì²´í¬ë¦¬ìŠ¤íŠ¸
            - âœ… TypeScript ì»´íŒŒì¼
            - âœ… ESLint ê²€ì‚¬
            - âœ… ë¹Œë“œ í…ŒìŠ¤íŠ¸
            - âœ… ë³´ì•ˆ ìŠ¤ìº”

            ### ğŸŒ í”„ë¦¬ë·° ë§í¬
            Vercelì´ ìë™ìœ¼ë¡œ í”„ë¦¬ë·° ë°°í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            ë°°í¬ ì™„ë£Œ í›„ ì•„ë˜ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            ---
            *ğŸ¤– ìë™ ìƒì„±ëœ ë©”ì‹œì§€ì…ë‹ˆë‹¤.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
